{"tags":[{"name":"Cocos2d-x","permalink":"http://blog.keepmovingxin.com/tags/Cocos2d-x/","url":"/async/tags/Cocos2d-x.json","count":3}],"categories":[{"name":"游戏开发","permalink":"http://blog.keepmovingxin.com/categories/游戏开发/","url":"/async/categories/游戏开发.json","count":6}],"url":"/async/posts/2016/05/09/Cocos2dx-CCRenderTexture.json","date":1462804288000,"path":{"year":2016,"month":5,"day":9,"name":"Cocos2dx-CCRenderTexture"},"title":"Cocos2d-x中动态纹理CCRenderTexture的使用","permalink":"http://blog.keepmovingxin.com/2016/05/09/Cocos2dx-CCRenderTexture/","content":"<p>记录一下Cocos2d-x中动态纹理<code>CCRenderTexture</code>的各种应用，实现截屏、阴影等等<br><a id=\"more\"></a></p>\n<p>使用<code>CCRenderTexture</code>需要做以下5步:</p>\n<ol>\n<li>创建一个新的<code>CCRenderTexture</code>. 这里，你可以指定将要创建的纹理的宽度和高度。</li>\n<li>调用 <code>CCRenderTexture:begin</code>. 这个方法会启动OpenGL，并且接下来，任何绘图的命令都会渲染到<code>CCRenderTexture</code>里面去，而不是画到屏幕上。</li>\n<li>绘制纹理. 你可以使用原始的<code>OpenGL</code>调用来绘图，或者你也可以使用cocos2d对象里面已经定义好的<code>visit</code>方法。（这个visit方法就会调用一些opengl命令来绘制cocos2d对象）</li>\n<li>调用 <code>CCRenderTexture:end</code>. 这个方法会渲染纹理，并且会关闭渲染至<code>CCRenderTexture</code>的通道。</li>\n<li>从生成的纹理中创建一个<code>sprite</code>. 你现在可以用<code>CCRenderTexture</code>的<code>sprite.texture</code>属性来轻松创建新的精灵了。</li>\n</ol>\n<h3 id=\"截取当前屏幕图片\"><a href=\"#截取当前屏幕图片\" class=\"headerlink\" title=\"截取当前屏幕图片\"></a>截取当前屏幕图片</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--[[</span><br><span class=\"line\">    @des:截取当前屏幕图片</span><br><span class=\"line\">    @ret:截取的图片路径</span><br><span class=\"line\">--]]</span><br><span class=\"line\">function getScreenshots()</span><br><span class=\"line\">    local size = CCDirector:sharedDirector():getWinSize()</span><br><span class=\"line\">    local renderTexture = CCRenderTexture:create(size.width, size.height,kCCTexture2DPixelFormat_RGBA8888)</span><br><span class=\"line\">    renderTexture:getSprite():setAnchorPoint( ccp(0.5,0.5) )</span><br><span class=\"line\">    renderTexture:setPosition( ccp(size.width/2, size.height/2) )</span><br><span class=\"line\">    renderTexture:setAnchorPoint( ccp(0.5,0.5) )</span><br><span class=\"line\"></span><br><span class=\"line\">    local runingScene = CCDirector:sharedDirector():getRunningScene()</span><br><span class=\"line\">    renderTexture:begin()</span><br><span class=\"line\">    runingScene:visit()</span><br><span class=\"line\">    renderTexture:endToLua()</span><br><span class=\"line\"></span><br><span class=\"line\">    local picPath = CCFileUtils:sharedFileUtils():getWritablePath() .. &quot;tempScreenshots.jpg&quot;</span><br><span class=\"line\">    print(&quot;截屏图片:&quot;,renderTexture:saveToFile(picPath))</span><br><span class=\"line\">    return picPath</span><br><span class=\"line\">end</span><br></pre></td></tr></table></figure>\n<h3 id=\"绘制精灵的影子\"><a href=\"#绘制精灵的影子\" class=\"headerlink\" title=\"绘制精灵的影子\"></a>绘制精灵的影子</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--[[</span><br><span class=\"line\">    @des:根据精灵绘制影子</span><br><span class=\"line\">    @par:pSprite 精灵</span><br><span class=\"line\">    @ret:shadowSprite 精灵影子</span><br><span class=\"line\">--]]</span><br><span class=\"line\">function getShadowSprite( pSprite )</span><br><span class=\"line\">    local size = pSprite:getContentSize()</span><br><span class=\"line\">    local renderTexture = CCRenderTexture:create(size.width, size.height,kCCTexture2DPixelFormat_RGBA8888)</span><br><span class=\"line\">    renderTexture:getSprite():setAnchorPoint( ccp(0.5,0.5) )</span><br><span class=\"line\">    renderTexture:setPosition( ccp(size.width/2, size.height/2) )</span><br><span class=\"line\">    renderTexture:setAnchorPoint( ccp(0.5,0.5) )</span><br><span class=\"line\">    </span><br><span class=\"line\">    renderTexture:beginWithClear(0,0,0,0)</span><br><span class=\"line\">    pSprite:visit()</span><br><span class=\"line\">    renderTexture:endToLua()</span><br><span class=\"line\">    </span><br><span class=\"line\">    local shadowSprite = CCSprite:createWithTexture(renderTexture:getSprite():getTexture())</span><br><span class=\"line\">    return shadowSprite</span><br><span class=\"line\">end</span><br></pre></td></tr></table></figure>\n<h3 id=\"绘制动态精灵\"><a href=\"#绘制动态精灵\" class=\"headerlink\" title=\"绘制动态精灵\"></a>绘制动态精灵</h3><p>　　注意，我们这里不是调用的<code>CCRenderTexture:begin</code>方法，而是调用另外一个较方便的方法<code>beginWithClear:g:b:a:</code>，这个方法可以用给定的颜色来清除纹理的背景，相当于设置画布的颜色。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-(CCSprite *)spriteWithColor:(ccColor4F)bgColor textureSize:(float)textureSize &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">// 1: Create new CCRenderTexture</span><br><span class=\"line\">CCRenderTexture *rt = [CCRenderTexture renderTextureWithWidth:textureSize height:textureSize];</span><br><span class=\"line\"></span><br><span class=\"line\">// 2: Call CCRenderTexture:begin</span><br><span class=\"line\">[rt beginWithClear:bgColor.r g:bgColor.g b:bgColor.b a:bgColor.a];</span><br><span class=\"line\"></span><br><span class=\"line\">// 3: Draw into the texture</span><br><span class=\"line\">// We&apos;ll add this later</span><br><span class=\"line\"></span><br><span class=\"line\">// 4: Call CCRenderTexture:end</span><br><span class=\"line\">[rt end];</span><br><span class=\"line\"></span><br><span class=\"line\">// 5: Create a new Sprite from the texture</span><br><span class=\"line\">return [CCSprite spriteWithTexture:rt.sprite.texture];</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">- (ccColor4F)randomBrightColor &#123;</span><br><span class=\"line\"> </span><br><span class=\"line\">    while (true) &#123;</span><br><span class=\"line\">        float requiredBrightness = 192;</span><br><span class=\"line\">        ccColor4B randomColor = </span><br><span class=\"line\">            ccc4(arc4random() % 255,</span><br><span class=\"line\">                 arc4random() % 255, </span><br><span class=\"line\">                 arc4random() % 255, </span><br><span class=\"line\">                 255);</span><br><span class=\"line\">        if (randomColor.r &gt; requiredBrightness || </span><br><span class=\"line\">            randomColor.g &gt; requiredBrightness ||</span><br><span class=\"line\">            randomColor.b &gt; requiredBrightness) &#123;</span><br><span class=\"line\">            return ccc4FFromccc4B(randomColor);</span><br><span class=\"line\">        &#125;        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">- (void)genBackground &#123;</span><br><span class=\"line\"> </span><br><span class=\"line\">    [_background removeFromParentAndCleanup:YES];</span><br><span class=\"line\"> </span><br><span class=\"line\">    ccColor4F bgColor = [self randomBrightColor];</span><br><span class=\"line\">    _background = [self spriteWithColor:bgColor textureWidth:IS_IPHONE_5 ? 1024:512 textureHeight:512];</span><br><span class=\"line\"> </span><br><span class=\"line\">    CGSize winSize = [CCDirector sharedDirector].winSize;</span><br><span class=\"line\">    _background.position = ccp(winSize.width/2, winSize.height/2);        </span><br><span class=\"line\">    [self addChild:_background z:-1];</span><br><span class=\"line\"> </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">- (void) onEnter &#123;</span><br><span class=\"line\">    [super onEnter];</span><br><span class=\"line\">    [self genBackground];</span><br><span class=\"line\">    [self setTouchEnabled:YES];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">- (void)ccTouchesBegan:(NSSet *)touches withEvent:(UIEvent *)event &#123;</span><br><span class=\"line\">    [self genBackground];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>　　<code>randomBrightColor</code>方法是一个辅助方法，用来创建一种随机颜色。注意，这里使用ccc4B（因此，我们能够在0-255的范围内指定R/G/B/A值），同时确保至少有一个颜色分量是大于192的，这样的话，我们就不会得到较暗的颜色。<br>　　然后，<code>genBackground</code>调用我们之前写的<code>spriteWithColor</code>方法，同时把它加屏幕中央。<br>　　至于<code>init</code>函数，它调用<code>genBackground</code>方法，同时激活<code>touches</code>事件，这样的话，你就可以通过点击屏幕来获得另外的随机背景了。<br>　　编译并运行，这样你每一次点击屏幕，你都可以得到一张不同的单色背景图片啦！</p>\n<h3 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h3><p><a href=\"https://www.raywenderlich.com/33266/how-to-create-dynamic-textures-with-ccrendertexture-in-cocos2d-2-x\" target=\"_blank\" rel=\"external\">How To Create Dynamic Textures with CCRenderTexture in Cocos2D 2.X</a><br><a href=\"http://www.cnblogs.com/andyque/archive/2011/07/01/2095479.html\" target=\"_blank\" rel=\"external\">(译)如何使用CCRenderTexture来创建动态纹理</a></p>\n<hr>\n<p>扫描二维码或在微信中搜索 KeepMovingXin<br><img src=\"/images/qrcode.jpg\" alt=\"欢迎关注微信公众号！\"></p>\n<hr>\n<p><strong>版权声明</strong><br><a href=\"http://blog.keepmovingxin.com\">KeepMoving</a> by <a href=\"http://blog.keepmovingxin.com/about\">KP_小新</a> 采用 <a href=\"http://creativecommons.org/licenses/by-nc-nd/4.0/\" target=\"_blank\" rel=\"external\">创作共用保留署名-非商业-禁止演绎4.0国际许可证</a><br>Copyright © 2016 <a href=\"http://blog.keepmovingxin.com\">KeepMoving</a>. All rights reserved.<br>原文链接：<a href=\"http://blog.keepmovingxin.com/2016/05/09/Cocos2dx-CCRenderTexture/\">http://blog.keepmovingxin.com/2016/05/09/Cocos2dx-CCRenderTexture/</a></p>\n"}